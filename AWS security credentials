#! /usr/local/bin/aws


for user in $(aws iam list-users | grep -i UserName | awk -F':|,' '{print $2}' | tr -d '"' | tr -d ' ')
do
creat_dat=`aws iam list-access-keys --user-name $user | grep -i CreateDate | awk '{print $2}' | tr -d '"' `
access_key=`aws iam list-access-keys --user-name $user | grep -i AccessKeyId | awk -F':|,' '{print $2}' | tr -d '"' | tr -d ' '`
prof_age=`echo $(( ($(date +'%s') - $(date -d ${creat_dat} +'%s')) / 86400))`
if [ $prof_age -gt 90 ]; then
   echo "$user was created $prof_age days ago. so it voilting secuity policy. it's credentials will be renewed"
   aws iam create-access-key --user-name $user
   aws iam update-access-key --access-key-id $access_key --status Inactive --user-name $user
   aws iam delete-access-key --access-key-id $access_key --user-name $user
else
     echo "$user was created $prof_age days ago. it is as per the secuity policy"
fi
done
